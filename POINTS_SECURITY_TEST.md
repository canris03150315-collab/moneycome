# 點數系統安全性測試指南

## ✅ 已實施的功能

### 1. 兩階段充值驗證
- ✅ 用戶提交充值申請
- ✅ 管理員審核通過/拒絕
- ✅ 審核通過才增加點數

### 2. 點數管理器
- ✅ 原子性操作（Firestore Transaction）
- ✅ 自動審計日誌
- ✅ 異常檢測
- ✅ 操作限制驗證

### 3. 安全限制
- ✅ 最小充值：100 點
- ✅ 最大單次充值：10,000 點
- ✅ 必須提供支付憑證

---

## 🧪 測試步驟

### 測試 1：用戶提交充值申請

**端點**: `POST /api/user/recharge/request`

**請求**:
```json
{
  "amount": 1000,
  "paymentMethod": "銀行轉帳",
  "paymentProof": "https://example.com/proof.jpg",
  "notes": "測試充值"
}
```

**預期結果**:
- ✅ 返回 `success: true`
- ✅ 返回 `requestId`
- ✅ 狀態為 `PENDING`
- ✅ 點數**不會**立即增加

---

### 測試 2：用戶查詢充值申請

**端點**: `GET /api/user/recharge/requests`

**預期結果**:
- ✅ 返回用戶的所有充值申請
- ✅ 包含狀態、金額、時間等資訊

---

### 測試 3：管理員查看充值申請

**端點**: `GET /api/admin/recharge/requests?status=PENDING`

**預期結果**:
- ✅ 返回所有待審核的充值申請
- ✅ 包含用戶資訊、支付憑證等

---

### 測試 4：管理員審核通過

**端點**: `POST /api/admin/recharge/:id/approve`

**請求**:
```json
{
  "notes": "已確認收款"
}
```

**預期結果**:
- ✅ 返回 `success: true`
- ✅ 用戶點數增加
- ✅ 創建交易記錄
- ✅ 創建審計日誌
- ✅ 申請狀態變為 `APPROVED`

---

### 測試 5：管理員拒絕申請

**端點**: `POST /api/admin/recharge/:id/reject`

**請求**:
```json
{
  "reason": "支付憑證不清楚"
}
```

**預期結果**:
- ✅ 返回 `success: true`
- ✅ 用戶點數**不變**
- ✅ 申請狀態變為 `REJECTED`

---

### 測試 6：舊的充值端點已禁用

**端點**: `POST /api/user/recharge`

**預期結果**:
- ✅ 返回 503 錯誤
- ✅ 提示使用新的充值申請流程

---

### 測試 7：金額驗證

**測試 7.1：金額過小**
```json
{
  "amount": 50,
  "paymentMethod": "銀行轉帳",
  "paymentProof": "xxx"
}
```
**預期**: ❌ 拒絕，提示「最小充值金額為 100 點」

**測試 7.2：金額過大**
```json
{
  "amount": 20000,
  "paymentMethod": "銀行轉帳",
  "paymentProof": "xxx"
}
```
**預期**: ❌ 拒絕，提示「單次充值上限為 10,000 點」

**測試 7.3：缺少支付憑證**
```json
{
  "amount": 1000,
  "paymentMethod": "銀行轉帳"
}
```
**預期**: ❌ 拒絕，提示「請提供支付方式和支付憑證」

---

## 📊 審計日誌查詢

### 查詢用戶的點數變動記錄

**Firestore 查詢**:
```javascript
db.firestore
  .collection('POINTS_AUDIT_LOG')
  .where('userId', '==', 'USER_ID')
  .orderBy('timestamp', 'desc')
  .limit(50)
  .get();
```

**預期包含**:
- ✅ 用戶 ID
- ✅ 操作類型 (RECHARGE, DRAW, etc.)
- ✅ 變動金額
- ✅ 操作前後點數
- ✅ 操作原因
- ✅ 相關訂單 ID
- ✅ 操作者 ID（管理員操作時）
- ✅ IP 地址
- ✅ 時間戳

---

## 🔍 驗證檢查清單

### 充值流程
- [ ] 用戶可以提交充值申請
- [ ] 申請需要支付憑證
- [ ] 金額限制正確執行
- [ ] 用戶可以查看自己的申請
- [ ] 管理員可以查看所有申請
- [ ] 管理員可以審核通過
- [ ] 管理員可以拒絕
- [ ] 審核通過後點數正確增加
- [ ] 拒絕後點數不變
- [ ] 舊的充值端點已禁用

### 審計日誌
- [ ] 所有點數變動都有日誌
- [ ] 日誌包含完整資訊
- [ ] 可以查詢歷史記錄
- [ ] 日誌不可篡改

### 安全性
- [ ] 原子性操作（無競態條件）
- [ ] 異常檢測正常工作
- [ ] 操作限制正確執行
- [ ] 權限檢查正確

---

## 🚨 測試異常情況

### 測試 8：重複審核
1. 審核通過一個申請
2. 再次嘗試審核同一個申請

**預期**: ❌ 拒絕，提示「此申請已處理」

---

### 測試 9：點數不足時的處理
1. 用戶點數為 100
2. 嘗試購買 200 點的商品

**預期**: ❌ 拒絕，提示「點數不足」

---

### 測試 10：並發操作
1. 同時發起 10 個抽獎請求
2. 檢查點數是否正確扣除

**預期**: ✅ 點數正確扣除 10 次（無重複或遺漏）

---

## 📈 監控指標

### 需要監控的數據

1. **充值申請數量**
   - 每日提交數量
   - 審核通過率
   - 平均審核時間

2. **點數變動**
   - 每日總增加量
   - 每日總扣除量
   - 異常大額操作

3. **審計日誌**
   - 日誌數量
   - 異常操作數量

---

## 🔧 故障排除

### 問題 1：充值審核通過但點數沒增加

**檢查**:
1. 查看後端日誌
2. 檢查審計日誌
3. 檢查 Firestore 用戶點數

**可能原因**:
- Transaction 失敗
- Session 未更新
- Firestore 寫入失敗

---

### 問題 2：審計日誌缺失

**檢查**:
1. 查看 Firestore `POINTS_AUDIT_LOG` 集合
2. 檢查後端日誌是否有錯誤

**可能原因**:
- 日誌創建失敗（但不影響主流程）
- Firestore 權限問題

---

## 📞 聯絡資訊

如發現問題，請提供：
- 操作時間
- 用戶 ID
- 充值申請 ID
- 錯誤訊息
- 後端日誌
