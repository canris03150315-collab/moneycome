# å…¬å¹³æ€§é©—è­‰è³‡è¨Šå¯¦ç¾ç¸½çµ

## ğŸ“‹ **å¯¦ç¾æ¦‚è¿°**

æˆåŠŸåœ¨å•†å“é é¢æ·»åŠ äº†å…¬å¹³æ€§é©—è­‰è³‡è¨Šé¡¯ç¤ºï¼ŒåŒ…æ‹¬ï¼š
- **ç±¤æ± æ‰¿è«¾ Hash (Pool Commitment Hash)** - é–‹è³£å‰ç”Ÿæˆï¼Œè­‰æ˜ç±¤æ± é †åºå·²å›ºå®š
- **ç±¤æ± ç¨®å­ç¢¼ (Pool Seed)** - å•†å“å”®å®Œå¾Œå…¬é–‹ï¼Œç”¨æ–¼å®Œæ•´é©—è­‰

---

## ğŸ¯ **å®Œæˆçš„å·¥ä½œ**

### **1. å‰ç«¯ä¿®æ”¹**
âœ… **å•†å“é é¢ (LotteryPage.tsx)**
- åœ¨çé …åˆ—è¡¨ä¸‹æ–¹æ·»åŠ å…¬å¹³æ€§é©—è­‰è³‡è¨Šå€å¡Š
- é¡¯ç¤ºç±¤æ± æ‰¿è«¾ Hash
- å•†å“å”®å®Œå¾Œé¡¯ç¤ºç±¤æ± ç¨®å­ç¢¼
- æœªå”®å®Œæ™‚é¡¯ç¤ºæç¤ºä¿¡æ¯

### **2. å¾Œç«¯ä¿®æ”¹**
âœ… **API ç«¯é» (server-firestore.js)**
- `/api/lottery-sets` - å•†å“åˆ—è¡¨ API è¿”å›é©—è­‰è³‡è¨Š
- `/api/lottery-sets/:id` - å•†å“è©³æƒ… API è¿”å›é©—è­‰è³‡è¨Š
- å¾ Firestore è®€å– `poolCommitmentHash` å’Œ `poolSeed`

### **3. æ•¸æ“šé·ç§»**
âœ… **é·ç§»è…³æœ¬ (backend/migrations/add-pool-verification-data.js)**
- ç‚ºæ‰€æœ‰ç¾æœ‰å•†å“ç”Ÿæˆé©—è­‰è³‡è¨Š
- ç”Ÿæˆéš¨æ©Ÿç¨®å­ç¢¼
- è¨ˆç®—ç±¤æ± æ‰¿è«¾ Hash
- åªç‚ºå”®å®Œå•†å“å…¬é–‹ç¨®å­ç¢¼

---

## ğŸ“Š **éƒ¨ç½²ç‹€æ…‹**

| çµ„ä»¶ | ç‰ˆæœ¬/ç‹€æ…‹ | å‚™è¨» |
|------|----------|------|
| **å‰ç«¯** | `ichiban-frontend-00276-256` | âœ… å·²éƒ¨ç½² |
| **å¾Œç«¯** | `ichiban-backend-new` (æœ€æ–°) | âœ… å·²éƒ¨ç½² |
| **æ•¸æ“šé·ç§»** | 6 å€‹å•†å“å·²æ›´æ–° | âœ… å·²åŸ·è¡Œ |
| **Git** | `87189b1` | âœ… å·²æ¨é€ |

---

## ğŸ” **é©—è­‰è³‡è¨Šç”Ÿæˆé‚è¼¯**

### **1. ç”Ÿæˆ prizeOrder**
```javascript
function buildPrizeOrder(prizes = []) {
  const order = [];
  const normals = prizes.filter(p => p && p.type === 'NORMAL');
  normals.forEach(p => {
    for (let i = 0; i < (p.total || 0); i++) {
      order.push(p.id);
    }
  });
  const lastOne = prizes.find(p => p && p.type === 'LAST_ONE');
  if (lastOne) {
    order.push(lastOne.id);
  }
  return order;
}
```

### **2. ç”Ÿæˆç¨®å­ç¢¼**
```javascript
function generatePoolSeed() {
  return crypto.randomBytes(32).toString('hex');
}
```

### **3. è¨ˆç®—æ‰¿è«¾ Hash**
```javascript
function calculateHash(prizeOrder, poolSeed) {
  const data = prizeOrder.join(',') + poolSeed;
  return crypto.createHash('sha256').update(data).digest('hex');
}
```

---

## ğŸ“± **å‰ç«¯é¡¯ç¤ºæ•ˆæœ**

### **å•†å“æœªå”®å®Œæ™‚**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ›¡ï¸ å…¬å¹³æ€§é©—è­‰è³‡è¨Š                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç±¤æ± æ‰¿è«¾ Hash (Pool Commitment)         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ a907fd63bf11c090...                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ âœ“ æ­¤ Hash åœ¨é–‹è³£å‰å·²ç”Ÿæˆï¼Œç¢ºä¿ç±¤æ± é †åº  â”‚
â”‚   ç„¡æ³•è¢«ç«„æ”¹                             â”‚
â”‚                                         â”‚
â”‚ ğŸ’¡ ç±¤æ± ç¨®å­ç¢¼å°‡åœ¨å•†å“å®Œå…¨å”®å®Œå¾Œå…¬é–‹ï¼Œ    â”‚
â”‚    å±†æ™‚å¯å‰å¾€ã€Œå…¬å¹³æ€§é©—è­‰ã€é é¢é€²è¡Œ      â”‚
â”‚    å®Œæ•´é©—è­‰ã€‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å•†å“å·²å”®å®Œæ™‚**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ›¡ï¸ å…¬å¹³æ€§é©—è­‰è³‡è¨Š                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç±¤æ± æ‰¿è«¾ Hash (Pool Commitment)         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ a907fd63bf11c090...                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ âœ“ æ­¤ Hash åœ¨é–‹è³£å‰å·²ç”Ÿæˆï¼Œç¢ºä¿ç±¤æ± é †åº  â”‚
â”‚   ç„¡æ³•è¢«ç«„æ”¹                             â”‚
â”‚                                         â”‚
â”‚ ç±¤æ± ç¨®å­ç¢¼ (Pool Seed) - å·²å”®å®Œå…¬é–‹     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 7cce1fb2d4a31eec...                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ âœ“ å•†å“å·²å”®å®Œï¼Œç¨®å­ç¢¼å·²å…¬é–‹ä¾›é©—è­‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ **æ•¸æ“šæµç¨‹**

### **å•†å“å‰µå»ºæ™‚**
1. ç®¡ç†å“¡å‰µå»ºå•†å“
2. ç³»çµ±ç”Ÿæˆ `prizeOrder`
3. ç³»çµ±ç”Ÿæˆéš¨æ©Ÿ `poolSeed`
4. ç³»çµ±è¨ˆç®— `poolCommitmentHash = SHA256(prizeOrder + poolSeed)`
5. å°‡ `poolCommitmentHash` å’Œ `prizeOrder` ä¿å­˜åˆ° Firestore
6. `poolSeed` æš«ä¸ä¿å­˜ï¼ˆä¿å¯†ï¼‰

### **å•†å“å”®å®Œæ™‚**
1. æœ€å¾Œä¸€å¼µç±¤è¢«æŠ½å‡º
2. ç³»çµ±å°‡ `poolSeed` ä¿å­˜åˆ° Firestore
3. ç”¨æˆ¶å¯ä»¥åœ¨å•†å“é é¢çœ‹åˆ°ç¨®å­ç¢¼
4. ç”¨æˆ¶å¯ä»¥å‰å¾€å…¬å¹³æ€§é©—è­‰é é¢é€²è¡Œå®Œæ•´é©—è­‰

### **ç”¨æˆ¶é©—è­‰æ™‚**
1. ç”¨æˆ¶è¤‡è£½ `poolCommitmentHash` å’Œ `poolSeed`
2. å‰å¾€å…¬å¹³æ€§é©—è­‰é é¢
3. è¼¸å…¥ç¨®å­ç¢¼å’Œç±¤åº
4. ç³»çµ±è¨ˆç®— Hash ä¸¦æ¯”å°
5. é©—è­‰æˆåŠŸ âœ…

---

## ğŸ“‚ **ä¿®æ”¹çš„æ–‡ä»¶**

### **å‰ç«¯**
- `components/LotteryPage.tsx` - æ·»åŠ é©—è­‰è³‡è¨Šé¡¯ç¤ºå€å¡Š

### **å¾Œç«¯**
- `backend/server-firestore.js` - API è¿”å›é©—è­‰è³‡è¨Š
- `backend/migrations/add-pool-verification-data.js` - æ•¸æ“šé·ç§»è…³æœ¬
- `backend/cloudbuild.yaml` - å¾Œç«¯éƒ¨ç½²é…ç½®

---

## ğŸ§ª **æ¸¬è©¦æ­¥é©Ÿ**

### **1. æ¸¬è©¦æœªå”®å®Œå•†å“**
1. å‰å¾€ä»»ä½•æœªå”®å®Œçš„å•†å“é é¢
2. æ»¾å‹•åˆ°çé …åˆ—è¡¨ä¸‹æ–¹
3. âœ… æ‡‰è©²çœ‹åˆ°ç±¤æ± æ‰¿è«¾ Hash
4. âœ… æ‡‰è©²çœ‹åˆ°æç¤ºï¼šç¨®å­ç¢¼å°‡åœ¨å”®å®Œå¾Œå…¬é–‹

### **2. æ¸¬è©¦å·²å”®å®Œå•†å“**
1. å‰å¾€å·²å”®å®Œçš„å•†å“é é¢
2. æ»¾å‹•åˆ°çé …åˆ—è¡¨ä¸‹æ–¹
3. âœ… æ‡‰è©²çœ‹åˆ°ç±¤æ± æ‰¿è«¾ Hash
4. âœ… æ‡‰è©²çœ‹åˆ°ç±¤æ± ç¨®å­ç¢¼

### **3. æ¸¬è©¦é©—è­‰åŠŸèƒ½**
1. è¤‡è£½å•†å“çš„ Hash å’Œç¨®å­ç¢¼
2. å‰å¾€å…¬å¹³æ€§é©—è­‰é é¢
3. è¼¸å…¥ç¨®å­ç¢¼å’Œç±¤åº
4. âœ… é©—è­‰æ‡‰è©²æˆåŠŸ

---

## ğŸ‰ **å¯¦ç¾æ•ˆæœ**

### **é€æ˜åº¦æå‡**
- âœ… ç”¨æˆ¶å¯ä»¥ç›´æ¥åœ¨å•†å“é é¢çœ‹åˆ°é©—è­‰è³‡è¨Š
- âœ… ä¸éœ€è¦å»å…¶ä»–é é¢å°±èƒ½ç¢ºèªç³»çµ±çš„å…¬å¹³æ€§

### **ä¿¡ä»»åº¦æå‡**
- âœ… é¡¯ç¤ºæ‰¿è«¾ Hash è­‰æ˜ç±¤æ± é †åºåœ¨é–‹è³£å‰å·²å›ºå®š
- âœ… å”®å®Œå¾Œå…¬é–‹ç¨®å­ç¢¼å…è¨±å®Œæ•´é©—è­‰

### **ç”¨æˆ¶é«”é©—æå‡**
- âœ… è¦–è¦ºåŒ–çš„é©—è­‰è³‡è¨Šå€å¡Š
- âœ… æ¸…æ™°çš„èªªæ˜æ–‡å­—
- âœ… æ ¹æ“šå•†å“ç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹

---

## ğŸ“ **å¾ŒçºŒå„ªåŒ–å»ºè­°**

### **1. æ·»åŠ ä¸€éµè¤‡è£½åŠŸèƒ½**
```typescript
const handleCopyHash = () => {
  navigator.clipboard.writeText(poolCommitmentHash);
  toast.show({ type: 'success', message: 'Hash å·²è¤‡è£½' });
};
```

### **2. æ·»åŠ é©—è­‰æŒ‰éˆ•**
```typescript
<button onClick={() => navigate('/verification')}>
  å‰å¾€é©—è­‰é é¢
</button>
```

### **3. æ·»åŠ é©—è­‰æ•™å­¸**
- é¡¯ç¤ºå¦‚ä½•ä½¿ç”¨é©—è­‰è³‡è¨Š
- æä¾›é©—è­‰æ­¥é©Ÿèªªæ˜

---

## âœ… **å®Œæˆæ¸…å–®**

- [x] å‰ç«¯æ·»åŠ é©—è­‰è³‡è¨Šé¡¯ç¤º
- [x] å¾Œç«¯ API è¿”å›é©—è­‰è³‡è¨Š
- [x] å‰µå»ºæ•¸æ“šé·ç§»è…³æœ¬
- [x] åŸ·è¡Œæ•¸æ“šé·ç§»ï¼ˆ6 å€‹å•†å“ï¼‰
- [x] éƒ¨ç½²å‰ç«¯
- [x] éƒ¨ç½²å¾Œç«¯
- [x] æ¨é€ä»£ç¢¼åˆ° Git
- [x] å‰µå»ºæ–‡æª”

---

## ğŸš€ **éƒ¨ç½²å‘½ä»¤**

### **å‰ç«¯éƒ¨ç½²**
```bash
gcloud builds submit --config=cloudbuild.yaml .
gcloud run services update-traffic ichiban-frontend --to-latest --region us-central1
```

### **å¾Œç«¯éƒ¨ç½²**
```bash
cd backend
gcloud builds submit --config=cloudbuild.yaml .
```

### **æ•¸æ“šé·ç§»**
```bash
cd backend
node migrations/add-pool-verification-data.js
```

---

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆä¸¦éƒ¨ç½²ï¼** ğŸŠ
