# 商城商品分類遷移指南

## 目的
為現有的商城商品添加 `categoryId` 字段，使其支持分類功能。

## 前置條件
1. 確保後端已部署到 Cloud Run
2. 確保 `serviceAccountKey.json` 存在於 `backend` 目錄
3. 確保已安裝 Node.js 和 npm

## 執行步驟

### 1. 進入 backend 目錄
```bash
cd backend
```

### 2. 確保依賴已安裝
```bash
npm install
```

### 3. 執行遷移腳本
```bash
node migrations/add-shop-product-categories.js
```

## 腳本功能

### 自動處理
- ✅ 檢查所有商城商品
- ✅ 識別缺少 `categoryId` 的商品
- ✅ 自動設置為默認分類（使用第一個可用分類）
- ✅ 批次更新所有商品
- ✅ 顯示詳細的遷移統計

### 輸出示例
```
========================================
開始遷移商城商品分類...
========================================

📂 正在讀取分類列表...
✅ 找到 5 個分類

可用分類：
  - anime: 動漫
  - game: 遊戲
  - figure: 公仔
  - card: 卡牌
  - other: 其他

🛍️  正在讀取商城商品...
✅ 找到 10 個商品

✓ shop-prod-1: 已有分類 (anime)
⚠ shop-prod-2: 缺少分類，將設置為 "anime"
⚠ shop-prod-3: 缺少分類，將設置為 "anime"
...

📝 正在更新 8 個商品...
✅ 批次更新成功！

========================================
遷移完成統計：
========================================
總商品數：10
已有分類：2
需要遷移：8
遷移成功：8
遷移失敗：0
========================================

已更新的商品：
  - shop-prod-2: "火影忍者公仔" → 分類: anime
  - shop-prod-3: "海賊王模型" → 分類: anime
  ...

⚠️  重要提示：
   這些商品已被設置為默認分類，請在後台管理中手動調整為正確的分類。

✅ 遷移腳本執行完成！
🎉 所有操作完成！
```

## 後續操作

### 手動調整分類
遷移完成後，建議：
1. 登入後台管理系統
2. 進入「商城商品管理」
3. 逐個檢查商品分類
4. 將商品調整到正確的分類

### 驗證結果
1. 前往商城商品頁面
2. 測試分類篩選功能
3. 確認所有商品都有分類

## 注意事項

⚠️ **重要**：
- 腳本會自動將所有沒有分類的商品設置為第一個可用分類
- 如果沒有任何分類，會使用 "other" 作為默認值
- 建議在執行前先創建好所需的分類
- 腳本使用批次更新，一次性處理所有商品

## 回滾方案
如果需要回滾，可以：
1. 手動在 Firestore 控制台刪除 `categoryId` 字段
2. 或者編寫反向遷移腳本

## 問題排查

### 錯誤：找不到 serviceAccountKey.json
```bash
# 確保文件存在
ls backend/serviceAccountKey.json

# 如果不存在，從 Firebase Console 下載
```

### 錯誤：權限不足
```bash
# 確保 Service Account 有 Firestore 寫入權限
```

### 錯誤：找不到分類
```bash
# 先在後台管理中創建分類
# 或者修改腳本使用固定的默認分類 ID
```

## 相關文件
- 遷移腳本：`migrations/add-shop-product-categories.js`
- 後端 API：`server-firestore.js` (line 2742-2850)
- 前端表單：`components/AdminShopProducts.tsx`
- 前端頁面：`components/ShopPage.tsx`
- 類型定義：`types.ts`
