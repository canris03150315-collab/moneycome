<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª¢æŸ¥ç”¨æˆ¶è§’è‰²</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        button {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976D2;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æª¢æŸ¥ç”¨æˆ¶è§’è‰²</h1>
        
        <div class="info">
            <strong>â„¹ï¸ èªªæ˜ï¼š</strong><br>
            æ­¤å·¥å…·å¯ä»¥æª¢æŸ¥ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„è§’è‰²ä¿¡æ¯ï¼Œå¹«åŠ©è¨ºæ–·æ¬Šé™å•é¡Œã€‚
        </div>
        
        <button onclick="checkCurrentUser()">æª¢æŸ¥ç•¶å‰ç”¨æˆ¶</button>
        <button onclick="checkBackendUser()">å¾å¾Œç«¯ç²å–ç”¨æˆ¶ä¿¡æ¯</button>
        <button onclick="testAdminAccess()">æ¸¬è©¦ç®¡ç†å“¡æ¬Šé™</button>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'https://ichiban-backend-new-248630813908.us-central1.run.app';
        
        function showResult(content) {
            const result = document.getElementById('result');
            result.textContent = content;
            result.style.display = 'block';
        }
        
        async function checkCurrentUser() {
            try {
                showResult('æ­£åœ¨æª¢æŸ¥...');
                
                // å¾ localStorage ç²å–ç”¨æˆ¶ä¿¡æ¯
                const userStr = localStorage.getItem('currentUser');
                
                if (!userStr) {
                    showResult('âŒ æœªæ‰¾åˆ°ç™»å…¥ç”¨æˆ¶\n\nè«‹å…ˆç™»å…¥ç³»çµ±');
                    return;
                }
                
                const user = JSON.parse(userStr);
                
                const info = `âœ… æ‰¾åˆ°ç”¨æˆ¶ä¿¡æ¯

ç”¨æˆ¶ ID: ${user.id || 'N/A'}
Email: ${user.email || 'N/A'}
ç”¨æˆ¶å: ${user.username || 'N/A'}
é»æ•¸: ${user.points || 0}

è§’è‰²ä¿¡æ¯ï¼š
- role: ${user.role || 'æœªè¨­ç½®'}
- roles: ${JSON.stringify(user.roles) || 'æœªè¨­ç½®'}

æ¬Šé™æª¢æŸ¥ï¼š
- æ˜¯å¦ç‚º ADMIN: ${user.role === 'ADMIN' || user.roles?.includes('ADMIN')}
- æ˜¯å¦ç‚º SUPER_ADMIN: ${user.role === 'SUPER_ADMIN' || user.roles?.includes('SUPER_ADMIN')}

æ‡‰è©²é¡¯ç¤ºå¾Œå°æŒ‰éˆ•: ${
    user.role === 'ADMIN' || 
    user.role === 'SUPER_ADMIN' || 
    user.roles?.includes('ADMIN') || 
    user.roles?.includes('SUPER_ADMIN')
}

å®Œæ•´ç”¨æˆ¶å°è±¡ï¼š
${JSON.stringify(user, null, 2)}`;
                
                showResult(info);
            } catch (error) {
                showResult(`âŒ éŒ¯èª¤: ${error.message}\n\n${error.stack}`);
            }
        }
        
        async function checkBackendUser() {
            try {
                showResult('æ­£åœ¨å¾å¾Œç«¯ç²å–...');
                
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                const info = `âœ… å¾Œç«¯ç”¨æˆ¶ä¿¡æ¯

ç”¨æˆ¶ ID: ${data.id || 'N/A'}
Email: ${data.email || 'N/A'}
ç”¨æˆ¶å: ${data.username || 'N/A'}
é»æ•¸: ${data.points || 0}

è§’è‰²ä¿¡æ¯ï¼š
- role: ${data.role || 'æœªè¨­ç½®'}
- roles: ${JSON.stringify(data.roles) || 'æœªè¨­ç½®'}

æ¬Šé™æª¢æŸ¥ï¼š
- æ˜¯å¦ç‚º ADMIN: ${data.role === 'ADMIN' || data.roles?.includes('ADMIN')}
- æ˜¯å¦ç‚º SUPER_ADMIN: ${data.role === 'SUPER_ADMIN' || data.roles?.includes('SUPER_ADMIN')}

å®Œæ•´éŸ¿æ‡‰ï¼š
${JSON.stringify(data, null, 2)}`;
                
                showResult(info);
            } catch (error) {
                showResult(`âŒ éŒ¯èª¤: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. æœªç™»å…¥\n2. Session éæœŸ\n3. ç¶²è·¯å•é¡Œ`);
            }
        }
        
        async function testAdminAccess() {
            try {
                showResult('æ­£åœ¨æ¸¬è©¦ç®¡ç†å“¡æ¬Šé™...');
                
                const response = await fetch(`${API_BASE}/api/admin/roles`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`HTTP ${response.status}: ${error.message || response.statusText}`);
                }
                
                const data = await response.json();
                
                const info = `âœ… ç®¡ç†å“¡æ¬Šé™æ¸¬è©¦æˆåŠŸ

å¯ç”¨è§’è‰²ï¼š
${data.roles.map(r => `- ${r.label} (${r.value})`).join('\n')}

ç•¶å‰ç”¨æˆ¶è§’è‰²: ${data.currentUserRole}
è§’è‰²åç¨±: ${data.currentUserRoleName}

å®Œæ•´éŸ¿æ‡‰ï¼š
${JSON.stringify(data, null, 2)}`;
                
                showResult(info);
            } catch (error) {
                showResult(`âŒ ç®¡ç†å“¡æ¬Šé™æ¸¬è©¦å¤±æ•—

éŒ¯èª¤: ${error.message}

å¯èƒ½åŸå› ï¼š
1. ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡
2. Session éæœŸ
3. è§’è‰²è¨­ç½®éŒ¯èª¤

è«‹æª¢æŸ¥ç”¨æˆ¶è§’è‰²æ˜¯å¦æ­£ç¢ºè¨­ç½®ç‚º ADMIN æˆ– SUPER_ADMIN`);
            }
        }
    </script>
</body>
</html>
